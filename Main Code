# intro -------------------------------------------------------------------
#load libraries

library(tidyverse)
library(readxl)
library(vegan)

setwd(< your working directory>)

birds <- read_xlsx("data/AVONET-Dataset-Aquatic.xlsx", sheet = "AVONET_Data")
summary(birds)

# ---------------- TRANSFORM DATA ------------------------ ##
#add genus as seperate column
birds <- birds %>% 
  mutate(Genus = word(Species, 1))

birds <- birds %>% 
  select(Species, Genus, everything())

## Add beak morphology ratios
    # culmen length/width
birds$cl_w <- birds$Beak.Length_Culmen/birds$Beak.Width

    # culmen length/depth
birds$cl_d <- birds$Beak.Length_Culmen/birds$Beak.Depth

    # nares length/width
birds$nl_w <- birds$Beak.Length_Nares/birds$Beak.Width

    # nares length/depth
birds$nl_d <- birds$Beak.Length_Nares/birds$Beak.Depth

    # width/depth
birds$w_d <- birds$Beak.Width/birds$Beak.Depth

#create beak - mass morphology ratios
  # culmen length/mass
birds$cl_m <- birds$Beak.Length_Culmen/birds$Mass

  #depth/mass
birds$d_m <- birds$Beak.Depth-birds$Mass

  #width/mass
birds$w_m <- birds$Beak.Width/birds$Mass

  # nares length/mass
birds$nl_m <- birds$Beak.Length_Nares/birds$Mass

# WHICH MDS IS THIS -----------------------------------------------------##

#species raws in data frame (maybe should not do that here...)
birds <- birds  %>% column_to_rownames("Species")

## Set seed to make it reproducable
set.seed(1234567)

#select columns of interest 
birds_beak <- birds %>% 
select(8, 9, 10, 11, 18)

#scale variables???
  
# birds_env made of family or order.   --> 
  birds_env <- birds %>% 
    select(1, 2)

#make an MDS --> the probelm comes out of the k 
birds_mds <- wcmdscale(vegdist(birds_beak, method = "bray"), k = 2) # 2 ordinations axes 

# Inspect the coordinates via the scores function
scores(birds_mds, tidy = TRUE)

# Summarise the means/min/max per axis
scores(birds_mds, tidy = TRUE) %>% 
  summarise(min1  = min(Dim1),
            mean1 = mean(Dim1),
            max1  = max(Dim1),
            min2  = min(Dim2),
            mean2 = mean(Dim2),
            max2  = max(Dim2)) %>% 
  round(3)

ordiplot(birds_mds, type = "text")

# retrieve ordination scores
birds_mds_scores <- scores(birds_mds, tidy = TRUE)
cor(birds_mds_scores$Dim1, birds_mds_scores$Dim2)
cor.test(birds_mds_scores$Dim1, birds_mds_scores$Dim2)

# Compute species scores (as weighted averages of the site scores)
speciesScores <- wascores(birds_mds, birds_beak)

# Inspect
speciesScores

# Plot ordination diagram and add the species scores as text labels
ordiplot(beaks_mds, type = "text")
text(speciesScores, labels = rownames(speciesScores), col = "red", cex = 0.6)
# Load data

# MDS for beak-order ------------------------------------------------------
  
#filter out independent variables
birds_env <- birds %>% 
  select(1, 2,3, 25, 26, 27, 28, 29)

#filter out dependent variables (ONLY BEAK THIS TIME)
birds_beak <- birds %>% 
  select(1, 9, 10, 11, 12)

# Convert to data.frame with rownames from Site column
birds_beak <- birds_beak %>% column_to_rownames("Species")

birds_beak_scaled <- scale(birds_beak)

# Set seed to make it reproducible
set.seed(1234567)

#make an MDS --> the probelm comes out of the k 
birds_mds <- wcmdscale(vegdist(birds_beak_scaled, method = "euclidean"), k = 2) # 2 ordinations axes 

birds_mds_scores <- scores(birds_mds, tidy = TRUE)

cor.test(birds_mds_scores$Dim1, birds_mds_scores$Dim2)

#calculate species scores
speciesScores <- wascores(birds_mds, birds_beak)

ordiplot(birds_mds, type = "points")
#text(speciesScores, labels = rownames(speciesScores), col = "red", cex = 0.6)
# Add convex-hulls for the different groups
ordihull(birds_mds, groups = birds_env$Order,
         col = c("red","green", "blue", "purple", "orange", "yellow", "darkgreen", "darkred", "darkblue"),
         label = TRUE)
#extract centroids, calculate differences between those to have an idea between the differences
#separate MDS on seperate clusters might be interesting to get rid of the overlap
#if we want to do somethings statistical, we need to do a PCA

#-------------------------------------------PCA_Beaks-----------------------
#filter out dependent variables (ONLY BEAK THIS TIME)
birds_beak <- birds %>% 
  select(1, 9, 10, 11, 12)

birds_beak

#preparing data for PCA
birds_beak <- birds_beak %>% column_to_rownames("Species")
birds_beak
# Perform PCA on scaled data
birds_pca <- rda(scale(birds_beak))

# Inspect by showing it in the console
birds_pca

# Eigenvalues retrieval
eigenvals(birds_pca)

# Retrieve eigenvalues PC axis and variance explained
summary(eigenvals(birds_pca))

# Create scree plot
screeplot(birds_pca)

# With broken stick
screeplot(birds_pca, bstick = TRUE)

# Create ordination diagram
ordiplot(birds_pca, type = "text")

# Create ordination diagram with arrows for the beak dimensions (length two times, depth and width)
biplot(birds_pca)

#------------------------------------------------------------------------
#General model for birds  
# Need to conduct PCA on morphological traits. 

#lm_birds<- lm(PCA axis for traits ~ Family + Order + Habitat + Habitat.Density+
"Migration", "Trophic.Level", "Trophic.Niche", data = birds)

# Retrieve residuals
birds$residuals <- residuals(lm_birds)

# Plot histogram --> test distribution of residuals !!!
ggplot(data = birds, mapping = aes(x = residuals)) +
  geom_histogram(aes(y = after_stat(density)),
                 fill = "white", colour = "black", bins = 5) +
  stat_theodensity(distri = "norm", colour = "red")

shapiro.test(birds$residuals) # normal

summary(lm_birds)


