# intro -------------------------------------------------------------------
#load libraries

library(tidyverse)
library(readxl)
library(vegan)

setwd(< your working directory>)

birds <- read_xlsx("data/AVONET-Dataset-Aquatic.xlsx", sheet = "AVONET_Data")
summary(birds)

# ---------------- TRANSFORM DATA ------------------------ ##
#add genus as seperate column
birds <- birds %>% 
  mutate(Genus = word(Species, 1))

birds <- birds %>% 
  select(Species, Genus, everything())

## Add beak morphology ratios
    # culmen length/width
birds$cl_w <- birds$Beak.Length_Culmen/birds$Beak.Width

    # culmen length/depth
birds$cl_d <- birds$Beak.Length_Culmen/birds$Beak.Depth

    # nares length/width
birds$nl_w <- birds$Beak.Length_Nares/birds$Beak.Width

    # nares length/depth
birds$nl_d <- birds$Beak.Length_Nares/birds$Beak.Depth

    # width/depth
birds$w_d <- birds$Beak.Width/birds$Beak.Depth

#create beak - mass morphology ratios
  # culmen length/mass
birds$cl_m <- birds$Beak.Length_Culmen/birds$Mass

  #depth/mass
birds$d_m <- birds$Beak.Depth-birds$Mass

  #width/mass
birds$w_m <- birds$Beak.Width/birds$Mass

  # nares length/mass
birds$nl_m <- birds$Beak.Length_Nares/birds$Mass

# MDS for beak-order ------------------------------------------------------
  
#filter out independent variables
birds_env <- birds %>% 
  select(1, 2,3, 25, 26, 27, 28, 29)

#filter out dependent variables (ONLY BEAK THIS TIME)
birds_beak <- birds %>% 
  select(1, 9, 10, 11, 12)

# Convert to data.frame with rownames from Site column
birds_beak <- birds_beak %>% column_to_rownames("Species")

birds_beak_scaled <- scale(birds_beak)

# Set seed to make it reproducible
set.seed(1234567)

#make an MDS --> the probelm comes out of the k 
birds_mds <- wcmdscale(vegdist(birds_beak_scaled, method = "euclidean"), k = 2) # 2 ordinations axes 

birds_mds_scores <- scores(birds_mds, tidy = TRUE)

cor.test(birds_mds_scores$Dim1, birds_mds_scores$Dim2)

#calculate species scores
speciesScores <- wascores(birds_mds, birds_beak)

ordiplot(birds_mds, type = "points")
#text(speciesScores, labels = rownames(speciesScores), col = "red", cex = 0.6)
# Add convex-hulls for the different groups
ordihull(birds_mds, groups = birds_env$Order,
         col = c("red","green", "blue", "purple", "orange", "yellow", "darkgreen", "darkred", "darkblue"),
         label = TRUE)
#extract centroids, calculate differences between those to have an idea between the differences
#separate MDS on seperate clusters might be interesting to get rid of the overlap
#if we want to do somethings statistical, we need to do a PCA

#-------------------------------------------PCA_Beaks-----------------------
#filter out dependent variables (ONLY BEAK THIS TIME)
birds_beak <- birds %>% 
  select(1, 9, 10, 11, 12)

birds_beak

#preparing data for PCA
birds_beak <- birds_beak %>% column_to_rownames("Species")
birds_beak
# Perform PCA on scaled data
birds_pca <- rda(scale(birds_beak))

# Inspect by showing it in the console
birds_pca

# Eigenvalues retrieval
eigenvals(birds_pca)

# Retrieve eigenvalues PC axis and variance explained
summary(eigenvals(birds_pca))

# Create scree plot
screeplot(birds_pca)

# With broken stick
screeplot(birds_pca, bstick = TRUE)

# Create ordination diagram
ordiplot(birds_pca, type = "text")

# Create ordination diagram with arrows for the beak dimensions (length two times, depth and width)
biplot(birds_pca)

#------------------------------------------------------------------------
#General Linear Model for birds  

#lm_birds<- lm(PCA axis for traits ~ Family + Order + Habitat + Habitat.Density+
"Migration", "Trophic.Level", "Trophic.Niche", data = birds)

# Retrieve residuals
birds$residuals <- residuals(lm_birds)

# Plot histogram --> test distribution of residuals !!!
ggplot(data = birds, mapping = aes(x = residuals)) +
  geom_histogram(aes(y = after_stat(density)),
                 fill = "white", colour = "black", bins = 5) +
  stat_theodensity(distri = "norm", colour = "red")

shapiro.test(birds$residuals) # normal

summary(lm_birds)

#------------------PCA on data of beaks without ratios and pelicans---------------

#prepare data-set, excluding pelicans and ratios
no_peli <- birds %>% 
  filter(Order != "Pelecaniformes")

birds_beak_nopeli <- no_peli %>% 
  select(1, 9, 10, 11, 12)

birds_beak_nopeli <- birds_beak_nopeli %>% column_to_rownames("Species")
birds_beak_nopeli

# Perform PCA on scaled data
beak_nopeli_pca <- rda(scale(birds_beak_nopeli))

# Inspect by showing it in the console
beak_nopeli_pca

# Eigenvalues retrieval
eigenvals(beak_nopeli_pca)

# Retrieve eigenvalues PC axis and variance explained
summary(eigenvals(beak_nopeli_pca))

# Create scree plot
screeplot(beak_nopeli_pca)

# With broken stick
screeplot(beak_nopeli_pca, bstick = TRUE)

# Create ordination diagram
ordiplot(beak_nopeli_pca, type = "text")

# Create ordination diagram with arrows for the beak dimensions (length two times, depth and width)
biplot(beak_nopeli_pca)

